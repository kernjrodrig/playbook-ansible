---
# Red Hat Insights has recommended one or more actions for you, a system administrator, to review and if you
# deem appropriate, deploy on your systems running Red Hat software. Based on the analysis, we have automatically
# generated an Ansible Playbook for you. Please review and test the recommended actions and the Playbook as
# they may contain configuration changes, updates, reboots and/or other changes to your systems. Red Hat is not
# responsible for any adverse outcomes related to these recommendations or Playbooks.
#
# ssh-security
# https://console.redhat.com/insights/remediations/c8912a5a-f71e-490b-b8fd-4b2e7a72345d
# Generated by Red Hat Insights on Tue, 25 Feb 2025 15:20:11 GMT
# Created by kjavier_rodriguez

- name: run insights to obtain latest diagnosis info
  hosts: localhost
  vars:
    insights_remediation: " c8912a5a-f71e-490b-b8fd-4b2e7a72345d"
    insights_signature_exclude: "/hosts,/vars/insights_signature,/vars/insights_remediation"
    insights_signature: !!binary |
      TFMwdExTMUNSVWRKVGlCUVIxQWdVMGxIVGtGVVZWSkZMUzB0TFMwS1ZtVnljMmx2YmpvZ1IyNTFV
      RWNnZGpFS0NtbFJTVlpCZDFWQldVaHBRblZqZG5jMU9FUXJhalZ3VGtGUmFtRkdVa0ZCYTBSVWNu
      UnZRVzFSVkRBdlFVODVaRlJyYlRablJHZHRabUkyVGxGMGFVNEtPWHBNYmtWcmRsaEpibVZQV2s0
      MWRGcDBPSEZWWmtaaFNYQnBSMEV5SzFGWU9GVlNaR2hWTDJOdmRIbDRLMWQ2UlZscU1sSlpaSEEz
      ZEVnM01IQXpWUXBpWjFwbVRGRTNkV2wxYm5NNGIwMXFaV3N5VURaVFVWcExXRmxhV1c0NVYyZENP
      V2R2VG5FMk9FZERXbXR3Um1KVFVqWXJTRVl3TWxwYVVUUlZTV0ZtQ21Ga05XSmplWElyZVVwbFoy
      TlFVVk5RYUhscmNtaGtaV1pQWm5ORk9YUlhlVmhXUjFwSk1ETnNXSGh3VEVaSlJsQlFZWFZRUzNB
      NE5WcHBha0Y0VjNvS2RHYzRTSGRGUjJzME5HRTFRa3BqYVdsdWQyNXJWV1pDVEc0NFVHeHVPRVF2
      TjNSc1NsZExUVWh4TmtsWVkwMW1NVzlVU1RKdWMzZDFXRkZzTUhsbWRRcHNUekYwVHpkWFpHVTJO
      QzlHT0dGdVptNVpUVUZ5TjNoamIxTTJaMU5sTDJWeWRuVnZOamt3YVVOWFYyWm5SV294WVhSd1Qx
      cDJjazF5YmxkSllYUlhDakZrYUVONFVqaGFabkE1UmxsQ2RXUnhZV05yYVhGWVNtNDBjbEppTTFo
      clFVWlNUVmQ0YTBseWJFVkdkRUZKYjJveVdrNDJabGRVYjJwQ1JVTmlRbmNLZG14RmQxWmxObGhR
      ZW5WYWVVRm9Sa0ZFZGxWcU1UZElLME01VnpCd1ZrcHlkM3BSVUV0cE1DOXJlRTFOZVV0UWJ6ZDNa
      R3BEU0dsalFtdHRRVk01TXdwR1ZYbzVUMWcxY0RRNFpIa3lhV1p6TDBOblIyMW5XWFZEWjI1UllW
      QjNWMkpHTUhkMGREQmlWVk55WldkUldWZ3JkV3hJTlhOQlJtMW9TVUZ1Ym1GdENsTkNWVUV5ZFZr
      MVpsZGlPVXhzTmpablIwcGlUSGxNY1ZSUVNFcFNTbWxXWjNKTEt6VnpTMHgyZDNnMmNqTXJjVnBr
      YTFoUVIza3hSM0ZTVlZKT1NGUUtXWFoxVm5sUGRIZHZVV2xCUm1rdlJYWmxPV05xV2xwdWEwcDVW
      MlZUV1RodVVtNDFlbll5TkhSUWJGSkdVVk5xZWtscWMxSlNhVVJvYzA1UWFGUlRhd3AxZGxkYVdI
      SjBWVlpoUlQwS1BVMDNMek1LTFMwdExTMUZUa1FnVUVkUUlGTkpSMDVCVkZWU1JTMHRMUzB0Q2c9
      PQ==
  become: true
  tasks:
    - name: obtain diagnosis info
      command: "insights-client --diagnosis{{ insights_remediation | regex_search('\\s[a-fA-F0-9]{8}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{12}') }}"
      register: insights_result
      changed_when: false
      check_mode: false
    - name: register insights report as fact for use by other plays
      set_fact: insights_report={{ insights_result.stdout }}

# SSH security is decreased when insecure cipher or hmac is enabled in the crypto policy
# Identifier: (advisor:hardening_ssh_hmac_cipher_rhel8_later|SSH_INSECURE_HMAC_CIPHER_RHEL8_LATER_CRYPTO,fix)
# Version: 415a5aeed5dc7dc97ee3b850de9aae6fa8e2843d
- name: Remove insecure cipher and mac
  hosts: localhost
  become: true

  vars:
    pydata: "{{ insights_report.details['hardening_ssh_hmac_cipher_rhel8_later|SSH_INSECURE_HMAC_CIPHER_RHEL8_LATER_CRYPTO'] | default('') }}"
    insights_signature_exclude: /hosts,/vars/insights_signature
    insights_signature: !!binary |
      TFMwdExTMUNSVWRKVGlCUVIxQWdVMGxIVGtGVVZWSkZMUzB0TFMwS1ZtVnljMmx2YmpvZ1IyNTFV
      RWNnZGpFS0NtbFJTV05DUVVGQ1EwRkJSMEpSU201UVlXRm5RVUZ2U2tWTmRuYzFPRVFyYWpWd1Rq
      QlNORkF2YVRod1JXZGpXWGRoV0ZodUwwbENSRUZEWTJkRmVVUUtabWw0SzNScU1IaFdUMmc1TDBO
      NVVXeHpNRVl3UTBnMFUyc3hVR3RZV0VreEswWXJNM0I2T1dKNlNsaHhjMGN5ZGxadVJXcHJaRVJ6
      V0RsSlZGUXlNUXBRY1hGQmRtNTZTbEI1ZWk5dVdHOXpibVpxVlZGNVlYRTNhV1ZYWVdnNVlVWlVZ
      bWhsVTBsaVZXRktORkJwTDFoQlUzVXhORlptU1RGM1VFWjRjVGRpQ2tkVlIwVkJkR3hwU2xkeVNs
      cHpkRkpNTjA1SVFtcEZRME5hZDNaUVVrVkZPVXhHVmpKTVZFTTRSa1ppUzFwdmNFb3ZlVEpHVHpo
      RlJFVXliMFk0YzFBS1VteHZVV2sxU25aUGRVZHdkRXgzU1c5NFdWZzBNRFZwZEZaVmMzWk5XbFps
      ZVROR2J6TlVNWFpYTkNzNFUzWjZLMDkzVDJKaE0wRnpUMFpGWWtWdVVBcHNLMVpJV2tOR2QwRlNi
      MVpxVjI1QlRucDFiVmxIWlVSRVMwUlhOREJyZDBJMU5rb3lSRFZtVlRGRGRHeERXVFlyY1d0MFVW
      SlhiVVJRTmxwRVMwcFBDbFpOU2xWUVprUlBWMlpvTmtkRE1HVlpiMVk0YVZOck9HdFZSMHhpVTJ3
      dlZDdEVUamh0V0dod1VrcFhkblJyYnpOU2NYaHdWREpzVWs1bWMyODVhWG9LTW10a1JsbDVlVmRo
      UjNreWMyZGtaa3ByTVdkNGJXSnJZazk2WkM5RFFYbGFRMEZPVjJ4aFVVTnNORFF6TUV4Wk5HeElS
      VWxRTVdKSlRVNVJTWEZWVXdwb0wxQjZTMlpTWVVOU1FrSkVXa0pHV2s4dlZrOW5TSE16VFRFd1RU
      bFhTSEZVZDJoc1dGaG5SRGxzYjFwVGMwUk9PRUo2V21sQ1IyaG1NM0JGZWtkcUNsbHlVVWgzYmk5
      cmRFbDZNR2hFZFdoc1EzTlRMMUpYWkZaM1NrZFJlbGhuTkZkcFZtMVFhM2xMVWtKcFFqRnNhblJt
      VWpnNGEyeFRORTg1V0RjdldVVUtUME0yWTJod2JHMTRaVzlPWkN0dU9IVldPSGRvUlVwaVJESmll
      VWcyUzBkWk1sTjBNRE5pY25oUWVYVnlNRTVuY2pGUldraFZjMFpIWjBwS1oxSjZRd3BYZUZwaVoy
      STRUV3hqVmpSalUySlZXWGhrVGdvOWIyMTZOd290TFMwdExVVk9SQ0JRUjFBZ1UwbEhUa0ZVVlZK
      RkxTMHRMUzBL
  tasks:
    - name: Remove insecure cipher and mac
      when: pydata != ''
      block:
        - name: Unset the release
          ansible.builtin.command: subscription-manager release --unset
          when: pydata.update_info.unset_lock | bool

        - name: Enable base repo
          ansible.builtin.command: subscription-manager repos --enable=rhel-8-for-x86_64-baseos-rpms
          when: pydata.update_info.enable_repo | bool

        - name: Update crypto-policies
          ansible.builtin.dnf:
            name: crypto-policies
            state: latest
          when: pydata.update_info.update_package | bool

        - name: Add include configuration into `/etc/ssh/sshd_config`
          ansible.builtin.lineinfile:
            path: /etc/ssh/sshd_config
            line: "Include /etc/ssh/sshd_config.d/*.conf"
          when: pydata.update_info.include_miss | bool and ansible_distribution_major_version == "9"

        - name: Create a pmod file
          ansible.builtin.command: touch /etc/crypto-policies/policies/modules/DISABLE-INSECURE-INSIGHTS.pmod

        - name: Add cipher disable into pmod file
          ansible.builtin.lineinfile:
            path: /etc/crypto-policies/policies/modules/DISABLE-INSECURE-INSIGHTS.pmod
            line: "{{ item }}"
          with_items: "{{ pydata.issue_configurations_for_resolution }}"

        - name: Apply a pmod file
          ansible.builtin.command: update-crypto-policies --set {{ pydata.update_info.current_policy }}:DISABLE-INSECURE-INSIGHTS

        - name: Add secure ciphers and macs into configuration file
          when: pydata.crypto_enabled_sshd_issue_configurations_playbook_add is defined and pydata.crypto_enabled_sshd_issue_configurations_playbook_add
          ansible.builtin.lineinfile:
            path: "{{ item[0] }}"
            line: '{{ item[2] }}'
          with_list: "{{ pydata.crypto_enabled_sshd_issue_configurations_playbook_add }}"

        - name: Remove insecure ciphers and macs from configuration file
          when: pydata.crypto_enabled_sshd_issue_configurations_playbook_update is defined and pydata.crypto_enabled_sshd_issue_configurations_playbook_update
          ansible.builtin.lineinfile:
            path: "{{ item[0] }}"
            regexp: '{{ item[1] }}'
            line: '{{ item[2] }}'
          with_list: "{{ pydata.crypto_enabled_sshd_issue_configurations_playbook_update }}"

        - name: Restart sshd
          ansible.builtin.service:
            name: sshd
            state: restarted


- name: run insights
  hosts: localhost
  become: true
  gather_facts: false
  vars:
    insights_signature_exclude: /hosts,/vars/insights_signature
    insights_signature: !!binary |
      TFMwdExTMUNSVWRKVGlCUVIxQWdVMGxIVGtGVVZWSkZMUzB0TFMwS1ZtVnljMmx2YmpvZ1IyNTFV
      RWNnZGpFS0NtbFJTVlpCZDFWQldVaHBRaXR6ZG5jMU9FUXJhalZ3VGtGUmFXdDRaeTh2WmtaRFoz
      QXlTblIxVEd0UU5qQnNTa3BZYm1GU1JGTjVjVVYwU0ZSNlRGY0tOVlZSVlc5MWEyUmpVRFJVUlZn
      d01EaDFhRkJHUzFaSmVrdFVTR2RsYTFOaU1UUXlkMjlQYm5sR2VUUnpRbEJrZEZoaGREVlliWEp0
      VGxsR1EwaEVWZ28xYVhSdlNrcDBPVzg1UWtkQlJVaDVZMFJ3SzBoNVNqWXphM0paZVRGUk1rOXVU
      azF3VjJaSmNtYzJUakJXVTJoa1JtVk1lR0ppTjBaMlpFaEpjbFo2Q2pJNGFrdHhOemx1Tm13eUx6
      aDZZVkJSTDFkWVZIWkNaMDVhUkVWTFJ6TmhSSFl3WVRkbWIyUnlPRWhEZGxseE5tNUhNRkZOY1RO
      U1ZFOXBkbFZtTTFnS1JuQnlhVTh2TDNKSlRDOVlSelE1TTA1NGFWSjBRakVyZEhSUk0wZHNhM1ZE
      ZFVwck1EQkdaREp0ZDNZNFprRnZaR2xUUW5aelQydEpZekZyV25adFN3cEJjR3BEY1ZKMWVHaExU
      MDgzYWxZM1FYSnRTV0p6TkhobVJrUkJVMkZaV2t4R01VMHZhME42ZWs1d1MwTjFhbE5hVUUxRlVt
      WlhhV2RHVGpGMWRqRjNDalpQSzB0b1pTdFJVRU5hUm5CV1kwVndSbTFSTVdwcWFrOVFPV2haSzNW
      alZWSnhSVEkyTlhGTWRuWnFSWE4wUW5WQk4xQkZNRVZ3UkRsaU5VaFZSM1lLTkZKemJXc3pNbFpC
      Vnl0WE5IWk1VRWQwZG1sQ00wSXpUbE0wZUhCdVIzSmlObGs1Y1cwNFZuVTJSRUZIV2xOYWRsbFlk
      bWQwTm1WR2N6RTVTVFZZUWdvMGVtcFVSRUlyTW1sT2NrcE9jM2d5YURoU1VGVnJMMmhZUzFKMGEy
      WnZZMlpKZVRkcGNWY3hiMGRsTlZSMmFqTTFSbXRqUld0YU9VRnpSMjl6WXpWMENuUlZkVlZJWWpS
      ME5EVTFSSE5EWlZWc1ZEZFNOakJDTTB4d1Z6TmlTRTF0YzFCMEx6RktNRFEwYm1KS2RFTkhUM1Jy
      UVVWWVRsVTJlbGxUTDNBMFFqSUtaSFYxY2tZdlNHUnFWWFJNVDNSdlNFTnlZVWd2WkZwaFRVNTZk
      MVZpZUc1VFZXUkdZU3R6TTBaNFJHczFVVkU0VVRaMVVucFpRbWw0WkcxeWREZGpUQXBKYTA1NlEy
      aHBRMDlrY3owS1BVMVZOMk1LTFMwdExTMUZUa1FnVUVkUUlGTkpSMDVCVkZWU1JTMHRMUzB0Q2c9
      PQ==
  tasks:
    - name: run insights
      command: insights-client
      changed_when: false
